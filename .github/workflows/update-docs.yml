name: Update Docs

on:
  push:
    branches:
      - main

jobs:
  update-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v8
        env:
          MINTLIFY_API_KEY: ${{ secrets.MINTLIFY_API_KEY }}
          PROJECT_ID: ${{ secrets.MINTLIFY_PROJECT_ID }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const projectId = process.env.PROJECT_ID;
            const apiKey = process.env.MINTLIFY_API_KEY;

            if (!projectId || !apiKey) {
              core.setFailed('Missing MINTLIFY_PROJECT_ID or MINTLIFY_API_KEY secrets');
              return;
            }

            const url = 'https://api.mintlify.com/v1/agent/' + projectId + '/job';

            const systemPrompt = [
              'You are a documentation specialist for Hyperscape, an AI-native MMORPG engine built on Three.js with ElizaOS AI agent integration. Your job is to perform COMPREHENSIVE documentation updates, not minimal edits.',
              '',
              '## Project Overview',
              'Hyperscape is a RuneScape-inspired MMORPG built on a custom 3D multiplayer engine. Key packages:',
              '- packages/shared/ - Core 3D engine (ECS, Three.js, PhysX, networking, React UI)',
              '- packages/server/ - Game server (Fastify, WebSockets, PostgreSQL)',
              '- packages/client/ - Web client (Vite, React)',
              '- packages/plugin-hyperscape/ - ElizaOS AI agent plugin',
              '- packages/physx-js-webidl/ - PhysX WASM bindings',
              '- packages/asset-forge/ - AI asset generation tools',
              '- packages/docs-site/ - Docusaurus documentation',
              '',
              '## Critical Instructions',
              '1. NEVER ask questions - make decisions autonomously',
              '2. If you cannot access the repository, report the error and exit immediately',
              '3. Be COMPREHENSIVE - update ALL relevant documentation, not just minimal changes',
              '4. Analyze ALL code changes in the recent commits to identify every documentation impact',
              '5. When editing files, REPLACE old content with new content - do not add new content alongside old content, as this creates merge conflicts',
              '',
              '## Documentation Update Checklist (complete ALL applicable items):',
              '',
              '### 1. API Documentation',
              '- Update TypeDoc-generated API docs for any changed/added/removed functions, classes, types',
              '- Ensure all public APIs are documented with parameters, return types, and examples',
              '- Update packages/docs-site/docs/api/ with any new modules or significant API changes',
              '',
              '### 2. README Files',
              '- Update root README.md for any feature, command, or configuration changes',
              '- Update package-specific READMEs (packages/*/README.md) for package-level changes',
              '- Ensure Quick Start guide reflects current setup requirements',
              '',
              '### 3. CLAUDE.md (Development Guide)',
              '- Update architecture documentation for structural changes',
              '- Update essential commands if new scripts are added',
              '- Update package descriptions for new features',
              '- Add any new troubleshooting entries',
              '',
              '### 4. Wiki/Guide Documentation',
              '- Update getting started guides',
              '- Update deployment documentation',
              '- Update environment variable documentation',
              '- Add new feature documentation with code examples',
              '',
              '### 5. Configuration Documentation',
              '- Document any new environment variables in .env.example files',
              '- Update port allocation tables if ports change',
              '- Document new configuration options',
              '',
              '### 6. Code Examples',
              '- Add or update code examples for new APIs',
              '- Ensure examples compile and are type-safe',
              '- Include both simple and advanced usage patterns',
              '',
              '## Quality Standards',
              '- Documentation must match the actual code behavior',
              '- All code examples must be syntactically correct',
              '- Use consistent formatting and terminology',
              '- Include migration notes for breaking changes',
              '- Cross-reference related documentation sections',
              '',
              '## Output Expectations',
              'Your PR should typically include 50-200+ lines of changes for meaningful feature PRs. If you are only making +12/-1 changes, you are likely missing documentation that needs updating. Review all changed files thoroughly.'
            ].join('\n');

            const userPrompt = [
              'Perform a COMPREHENSIVE documentation update for all recent commits pushed to main.',
              '',
              'Repository: ' + owner + '/' + repo,
              '',
              '## Required Steps:',
              '',
              '1. Analyze All Recent Commits - Review every file changed in recent commits to main. Identify:',
              '   - New features or APIs added',
              '   - Modified APIs or behaviors',
              '   - Removed or deprecated functionality',
              '   - Configuration changes',
              '   - New dependencies or requirements',
              '',
              '2. Update ALL Relevant Documentation:',
              '   - API reference docs (TypeDoc in packages/docs-site/)',
              '   - README.md (root and package-level)',
              '   - CLAUDE.md development guide',
              '   - Any guides or tutorials affected',
              '   - Environment variable documentation',
              '   - Command reference tables',
              '',
              '3. Ensure Completeness:',
              '   - Every public API must be documented',
              '   - Every new feature must have documentation',
              '   - Every breaking change must have migration notes',
              '   - All code examples must be updated to match current APIs',
              '',
              '4. Create a Single PR with all documentation updates. The PR description should:',
              '   - List all documentation files updated',
              '   - Summarize what code changes triggered each update',
              '   - Note any areas needing manual review',
              '',
              'Remember: A comprehensive PR typically has 50-200+ lines of documentation changes for significant feature work. Minimal edits (+12/-1) are usually insufficient - dig deeper into what changed.'
            ].join('\n');

            const payload = {
              branch: `mintlify/docs-update-${Date.now()}`,
              messages: [
                {
                  role: 'system',
                  content: systemPrompt
                },
                {
                  role: 'user',
                  content: userPrompt
                }
              ],
              asDraft: false
            };

            try {
              const response = await fetch(url, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${apiKey}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
              });

              if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}: ${await response.text()}`);
              }

              const reader = response.body.getReader();
              const decoder = new TextDecoder();
              let buffer = '';

              while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';
                for (const line of lines) {
                  if (line.trim()) {
                    console.log(line);
                  }
                }
              }
              if (buffer.trim()) {
                console.log(buffer);
              }

              core.notice(`Documentation update job triggered for ${owner}/${repo}`);
            } catch (error) {
              core.setFailed(`Failed to create documentation update job: ${error.message}`);
            }
