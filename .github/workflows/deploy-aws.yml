# ============================================================================
# Hyperscape AWS Deployment Pipeline
# ============================================================================
# Deploys Hyperscape to AWS infrastructure:
# - Server: ECS Fargate via Docker/ECR
# - Frontend: S3 + CloudFront
# - Assets: S3 + CloudFront CDN
# - Asset Forge API: ECS Fargate via Docker/ECR
# - Asset Forge Frontend: S3 + CloudFront
#
# Triggers:
# - Push to main branch
# - Manual workflow dispatch
# ============================================================================

name: Deploy to AWS

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      deploy_server:
        description: 'Deploy Server'
        required: false
        type: boolean
        default: true
      deploy_frontend:
        description: 'Deploy Frontend'
        required: false
        type: boolean
        default: true
      deploy_assets:
        description: 'Deploy Assets'
        required: false
        type: boolean
        default: false
      deploy_asset_forge_api:
        description: 'Deploy Asset Forge API'
        required: false
        type: boolean
        default: true
      deploy_asset_forge_frontend:
        description: 'Deploy Asset Forge Frontend'
        required: false
        type: boolean
        default: true
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - prod
          - staging
        default: prod

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: hyperscape
  # CloudFront Distribution IDs (hardcoded for reliability)
  FRONTEND_CF_ID: E33M5Z892CLIMU
  ASSETS_CF_ID: E3VN6ASS8GLXT3
  ASSET_FORGE_CF_ID: E3ARBZ888IU1HA

permissions:
  id-token: write
  contents: read

jobs:
  # ============================================================================
  # Build and Test
  # ============================================================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.1.38

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Build Shared Package
        run: bun run build:shared

      - name: Run Type Check
        run: bun run typecheck || true

      - name: Build Server
        run: bun run build:server

      - name: Build Frontend
        env:
          PUBLIC_CDN_URL: "https://d20g7vd4m53hpb.cloudfront.net"
          PUBLIC_API_URL: "https://api.hyperscape.lol"
          PUBLIC_WS_URL: "wss://api.hyperscape.lol/ws"
          PUBLIC_APP_URL: "https://hyperscape.lol"
          PUBLIC_ELIZAOS_URL: "https://api.hyperscape.lol"
          PUBLIC_PRIVY_APP_ID: ${{ secrets.PRIVY_APP_ID }}
        run: |
          cd packages/client
          bun run build

      - name: Build Asset Forge Frontend
        run: |
          cd packages/asset-forge
          VITE_API_URL="https://forge-api.hyperscape.lol" \
          VITE_IMAGE_SERVER_URL="https://forge-api.hyperscape.lol" \
          NODE_ENV=production \
          bun run build

      - name: Upload Server Artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-build
          path: |
            packages/server/
            packages/shared/build/
            packages/plugin-hyperscape/
            packages/physx-js-webidl/
            assets/manifests/
            package.json
            bun.lock
            turbo.json
          retention-days: 1

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: packages/client/dist/
          retention-days: 1

      - name: Upload Asset Forge API Artifact
        uses: actions/upload-artifact@v4
        with:
          name: asset-forge-api-build
          path: |
            packages/asset-forge/
            package.json
            bun.lock
          retention-days: 1

      - name: Upload Asset Forge Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: asset-forge-frontend-build
          path: packages/asset-forge/dist/
          retention-days: 1

  # ============================================================================
  # Deploy Server
  # ============================================================================
  deploy-server:
    name: Deploy Server
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event.inputs.deploy_server == true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Server Artifact
        uses: actions/download-artifact@v4
        with:
          name: server-build
          path: .

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set Environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
          else
            ENVIRONMENT="prod"
          fi
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "Using environment: ${ENVIRONMENT}"

      - name: Verify Infrastructure Exists
        env:
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
        run: |
          CLUSTER_NAME="${PROJECT_NAME}-${ENVIRONMENT}-cluster"
          SERVICE_NAME="${PROJECT_NAME}-${ENVIRONMENT}-server"
          
          echo "Verifying infrastructure exists..."
          echo "Checking cluster: $CLUSTER_NAME"
          
          if ! aws ecs describe-clusters --clusters $CLUSTER_NAME --region $AWS_REGION --query 'clusters[0].clusterName' --output text 2>/dev/null | grep -q "$CLUSTER_NAME"; then
            echo "âŒ Error: ECS cluster '$CLUSTER_NAME' does not exist!"
            echo "Please deploy infrastructure first using Terraform:"
            echo "  cd infrastructure && terraform apply"
            exit 1
          fi
          
          echo "âœ“ Cluster exists: $CLUSTER_NAME"
          
          if ! aws ecs describe-services --cluster $CLUSTER_NAME --services $SERVICE_NAME --region $AWS_REGION --query 'services[0].serviceName' --output text 2>/dev/null | grep -q "$SERVICE_NAME"; then
            echo "âŒ Error: ECS service '$SERVICE_NAME' does not exist!"
            echo "Please deploy infrastructure first using Terraform:"
            echo "  cd infrastructure && terraform apply"
            exit 1
          fi
          
          echo "âœ“ Service exists: $SERVICE_NAME"

      - name: Build, tag, and push image to ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
        run: |
          ECR_REPOSITORY="${PROJECT_NAME}-${ENVIRONMENT}-server"
          
          echo "Building Docker image..."
          echo "Repository: $ECR_REGISTRY/$ECR_REPOSITORY"
          echo "Tag: $IMAGE_TAG"
          
          docker build \
            --platform linux/amd64 \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -f packages/server/Dockerfile . || {
              echo "âŒ Docker build failed!"
              exit 1
            }
          
          echo "Tagging image as latest..."
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "Pushing image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG || {
            echo "âŒ Failed to push image tag $IMAGE_TAG"
            exit 1
          }
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest || {
            echo "âŒ Failed to push image tag latest"
            exit 1
          }
          
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "âœ“ Image pushed successfully"

      - name: Deploy to ECS
        env:
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
        run: |
          CLUSTER_NAME="${PROJECT_NAME}-${ENVIRONMENT}-cluster"
          SERVICE_NAME="${PROJECT_NAME}-${ENVIRONMENT}-server"
          
          echo "Deploying to ECS..."
          echo "Cluster: $CLUSTER_NAME"
          echo "Service: $SERVICE_NAME"
          
          aws ecs update-service \
            --cluster $CLUSTER_NAME \
            --service $SERVICE_NAME \
            --force-new-deployment \
            --region $AWS_REGION || {
              echo "âŒ Failed to update ECS service"
              exit 1
            }
          
          echo "âœ“ ECS service update initiated"

      - name: Wait for ECS Service Stability
        env:
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
        run: |
          CLUSTER_NAME="${PROJECT_NAME}-${ENVIRONMENT}-cluster"
          SERVICE_NAME="${PROJECT_NAME}-${ENVIRONMENT}-server"
          
          echo "Waiting for ECS service to stabilize..."
          echo "This may take several minutes..."
          
          aws ecs wait services-stable \
            --cluster $CLUSTER_NAME \
            --services $SERVICE_NAME \
            --region $AWS_REGION || {
              echo "âš ï¸  Service did not stabilize within timeout, but deployment was initiated"
              echo "Check ECS console for service status"
            }
          
          echo "âœ“ ECS deployment completed"

  # ============================================================================
  # Deploy Asset Forge API
  # ============================================================================
  deploy-asset-forge-api:
    name: Deploy Asset Forge API
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event.inputs.deploy_asset_forge_api == true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Asset Forge API Artifact
        uses: actions/download-artifact@v4
        with:
          name: asset-forge-api-build
          path: .

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set Environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
          else
            ENVIRONMENT="prod"
          fi
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "Using environment: ${ENVIRONMENT}"

      - name: Verify Infrastructure Exists
        env:
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
        run: |
          CLUSTER_NAME="${PROJECT_NAME}-${ENVIRONMENT}-cluster"
          SERVICE_NAME="${PROJECT_NAME}-${ENVIRONMENT}-asset-forge-api"
          
          echo "Verifying infrastructure exists..."
          if ! aws ecs describe-clusters --clusters $CLUSTER_NAME --region $AWS_REGION --query 'clusters[0].clusterName' --output text 2>/dev/null | grep -q "$CLUSTER_NAME"; then
            echo "âŒ Error: ECS cluster '$CLUSTER_NAME' does not exist!"
            exit 1
          fi
          echo "âœ“ Cluster exists"

      - name: Build, tag, and push image to ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
        run: |
          ECR_REPOSITORY="${PROJECT_NAME}-${ENVIRONMENT}-asset-forge-api"
          
          docker build \
            --platform linux/amd64 \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -f packages/asset-forge/Dockerfile . || {
              echo "âŒ Docker build failed!"
              exit 1
            }
          
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG || exit 1
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest || exit 1
          
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Deploy to ECS
        env:
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
        run: |
          CLUSTER_NAME="${PROJECT_NAME}-${ENVIRONMENT}-cluster"
          SERVICE_NAME="${PROJECT_NAME}-${ENVIRONMENT}-asset-forge-api"
          
          aws ecs update-service \
            --cluster $CLUSTER_NAME \
            --service $SERVICE_NAME \
            --force-new-deployment \
            --region $AWS_REGION || exit 1

      - name: Wait for ECS Service Stability
        env:
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
        run: |
          CLUSTER_NAME="${PROJECT_NAME}-${ENVIRONMENT}-cluster"
          SERVICE_NAME="${PROJECT_NAME}-${ENVIRONMENT}-asset-forge-api"
          
          echo "Waiting for ECS service to stabilize..."
          aws ecs wait services-stable \
            --cluster $CLUSTER_NAME \
            --services $SERVICE_NAME \
            --region $AWS_REGION || {
              echo "âš ï¸  Service did not stabilize within timeout"
            }
          
          echo "âœ“ Asset Forge API deployment completed"

  # ============================================================================
  # Deploy Frontend
  # ============================================================================
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event.inputs.deploy_frontend == true

    steps:
      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: dist/

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set Environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
          else
            ENVIRONMENT="prod"
          fi
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT

      - name: Deploy to S3
        env:
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
        run: |
          BUCKET_NAME="${PROJECT_NAME}-${ENVIRONMENT}-frontend"
          
          aws s3 sync dist/ s3://$BUCKET_NAME --delete
          
          # Set cache headers for HTML (no cache)
          aws s3 cp s3://$BUCKET_NAME s3://$BUCKET_NAME \
            --recursive \
            --exclude "*" \
            --include "*.html" \
            --metadata-directive REPLACE \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html"
          
          # Set cache headers for JS (long cache, immutable)
          aws s3 cp s3://$BUCKET_NAME/assets s3://$BUCKET_NAME/assets \
            --recursive \
            --exclude "*" \
            --include "*.js" \
            --metadata-directive REPLACE \
            --cache-control "public, max-age=31536000, immutable" \
            --content-type "application/javascript"
          
          echo "âœ“ Uploaded to s3://$BUCKET_NAME"

      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id $FRONTEND_CF_ID \
            --paths "/*"
          echo "âœ“ CloudFront cache invalidated"

  # ============================================================================
  # Deploy Asset Forge Frontend
  # ============================================================================
  deploy-asset-forge-frontend:
    name: Deploy Asset Forge Frontend
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event.inputs.deploy_asset_forge_frontend == true

    steps:
      - name: Download Asset Forge Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: asset-forge-frontend-build
          path: dist/

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set Environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
          else
            ENVIRONMENT="prod"
          fi
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT

      - name: Deploy to S3
        env:
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
        run: |
          BUCKET_NAME="${PROJECT_NAME}-${ENVIRONMENT}-asset-forge"
          
          aws s3 sync dist/ s3://$BUCKET_NAME --delete
          
          # Set cache headers for HTML (no cache)
          aws s3 cp s3://$BUCKET_NAME s3://$BUCKET_NAME \
            --recursive \
            --exclude "*" \
            --include "*.html" \
            --metadata-directive REPLACE \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html"
          
          # Set cache headers for JS (long cache, immutable)
          aws s3 cp s3://$BUCKET_NAME/assets s3://$BUCKET_NAME/assets \
            --recursive \
            --exclude "*" \
            --include "*.js" \
            --metadata-directive REPLACE \
            --cache-control "public, max-age=31536000, immutable" \
            --content-type "application/javascript"
          
          echo "âœ“ Uploaded to s3://$BUCKET_NAME"

      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id $ASSET_FORGE_CF_ID \
            --paths "/*"
          echo "âœ“ Asset Forge CloudFront cache invalidated"

  # ============================================================================
  # Deploy Assets (Manual Only)
  # ============================================================================
  deploy-assets:
    name: Deploy Assets
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_assets == true

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set Environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
          else
            ENVIRONMENT="prod"
          fi
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT

      - name: Deploy Assets to S3
        env:
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
        run: |
          BUCKET_NAME="${PROJECT_NAME}-${ENVIRONMENT}-assets"
          
          # Sync assets with long cache headers
          aws s3 sync assets/ s3://$BUCKET_NAME \
            --delete \
            --exclude ".git/*" \
            --exclude ".DS_Store" \
            --cache-control "public, max-age=31536000"
          
          # Set correct MIME types for WASM files
          aws s3 cp s3://$BUCKET_NAME s3://$BUCKET_NAME \
            --recursive \
            --exclude "*" \
            --include "*.wasm" \
            --metadata-directive REPLACE \
            --content-type "application/wasm" \
            --cache-control "public, max-age=31536000"
          
          # Set correct MIME types for GLB files
          aws s3 cp s3://$BUCKET_NAME s3://$BUCKET_NAME \
            --recursive \
            --exclude "*" \
            --include "*.glb" \
            --metadata-directive REPLACE \
            --content-type "model/gltf-binary" \
            --cache-control "public, max-age=31536000"
          
          echo "âœ“ Assets uploaded to s3://$BUCKET_NAME"

      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id $ASSETS_CF_ID \
            --paths "/*"
          echo "âœ“ Assets CloudFront cache invalidated"

  # ============================================================================
  # Notify
  # ============================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy-server, deploy-frontend, deploy-asset-forge-api, deploy-asset-forge-frontend]
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Server | ${{ needs.deploy-server.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Asset Forge API | ${{ needs.deploy-asset-forge-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Asset Forge Frontend | ${{ needs.deploy-asset-forge-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ Frontend: https://hyperscape.lol" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ® API: https://api.hyperscape.lol" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ Asset Forge: https://forge.hyperscape.lol" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ CDN: https://d20g7vd4m53hpb.cloudfront.net" >> $GITHUB_STEP_SUMMARY