---
description: Provider implementation patterns for Hyperscape plugin
globs: packages/plugin-eliza/src/providers/**/*.ts
alwaysApply: false
---

# Hyperscape Plugin - Provider Patterns

> Patterns for implementing ElizaOS providers in the Hyperscape plugin.

## Reference Files

- Game state: @packages/plugin-eliza/src/providers/gameState.ts
- Inventory: @packages/plugin-eliza/src/providers/inventory.ts
- Nearby entities: @packages/plugin-eliza/src/providers/nearbyEntities.ts
- Skills: @packages/plugin-eliza/src/providers/skills.ts
- Equipment: @packages/plugin-eliza/src/providers/equipment.ts
- Available actions: @packages/plugin-eliza/src/providers/availableActions.ts

## Provider Structure

Implement Provider interface with dynamic context:

```typescript
import type { Provider, IAgentRuntime, Memory, State, ProviderResult } from '@elizaos/core';
import type { HyperscapeService } from '../services/HyperscapeService.js';

export const providerName: Provider = {
  name: 'providerName',
  description: 'What context this provides',
  dynamic: true,  // REQUIRED for real-time game data
  position: 1,    // Order in provider chain

  get: async (
    runtime: IAgentRuntime,
    message: Memory,
    state: State
  ): Promise<ProviderResult> => {
    const service = runtime.getService<HyperscapeService>('hyperscapeService');
    
    if (!service || !service.isConnected()) {
      return {
        text: 'Provider unavailable (not connected)',
        values: {},
        data: {},
      };
    }

    // Fetch data from service
    const data = service.getSomeData();

    // Format text for LLM consumption
    const text = `Formatted context for LLM:
- Key: ${data.value}
- Status: ${data.status}`;

    return {
      text,  // For LLM context
      values: { /* structured data */ },  // For programmatic use
      data: { /* raw data */ },  // For processing
    };
  },
};
```

## Provider Rules

- **ALWAYS** set `dynamic: true` for real-time game data
- **ALWAYS** set `position` number for provider ordering
- **ALWAYS** check service availability before accessing world state
- **ALWAYS** format `text` for LLM consumption (clear, structured)
- **ALWAYS** return `ProviderResult` with `text`, `values`, `data`
- **ALWAYS** handle missing data gracefully (return empty/default values)
- **NEVER** perform side effects in providers (read-only)
- **NEVER** cache provider results (always fetch fresh data)

## Provider Result Formatting

**Text Format:** Formatted for LLM consumption
```typescript
text: `## Current State
- Health: ${health.current}/${health.max} HP
- Position: [${pos.x}, ${pos.y}, ${pos.z}]
- Status: ${alive ? 'Alive' : 'Dead'}`
```

**Values Format:** Structured data for templates
```typescript
values: {
  health: health.current,
  maxHealth: health.max,
  healthPercent: Math.round((health.current / health.max) * 100),
  position: { x: pos.x, y: pos.y, z: pos.z },
  alive: alive
}
```

**Data Format:** Raw data for processing
```typescript
data: {
  health: { current: 100, max: 100 },
  position: [10, 0, 20],
  alive: true,
  inCombat: false
}
```

**Rules:**
- ✅ **ALWAYS** format `text` clearly for LLM comprehension
- ✅ **ALWAYS** provide structured `values` for templates
- ✅ **ALWAYS** include raw `data` for programmatic access
- ✅ **ALWAYS** use consistent formatting across providers

## Advanced Patterns

For advanced patterns (conditional providers, aggregating providers), see:
- `.cursor/rules/plugin-eliza-provider-patterns.mdc` - Advanced provider patterns
- `.cursor/memory/elizaos-action-patterns.md` - Complete pattern reference

## Provider Ordering

Set `position` to control provider chain order:
1. `gameState` - position: 1 (foundation state)
2. `inventory` - position: 2
3. `nearbyEntities` - position: 3
4. `skills` - position: 4
5. `equipment` - position: 5
6. `availableActions` - position: 6 (depends on other providers)

## Common Patterns

### Service Availability Check
```typescript
const service = runtime.getService<HyperscapeService>('hyperscapeService');
if (!service || !service.isConnected()) {
  return { text: 'Unavailable', values: {}, data: {} };
}
```

### Data Formatting for LLM
```typescript
const text = `## Current State
- Health: ${health.current}/${health.max} HP
- Position: [${pos.x}, ${pos.y}, ${pos.z}]
- Status: ${alive ? 'Alive' : 'Dead'}`;
```
