# Nixpacks configuration for Railway deployment
# This file configures how Railway builds the Hyperscape server

[phases.setup]
# Install system dependencies needed for native modules (canvas, better-sqlite3)
aptPkgs = [
  "python3",
  "make",
  "g++",
  "pkg-config",
  "libcairo2-dev",
  "libpango1.0-dev",
  "libjpeg-dev",
  "libgif-dev",
  "librsvg2-dev",
  "ca-certificates"
]

[phases.install]
# Use bun for package installation
cmds = ["bun install"]

[phases.build]
# Build the packages in correct order: shared -> client -> server
# Then copy client dist to server public for static serving
# Note: Assets/manifests are fetched from CDN at server startup
dependsOn = ["install"]
cmds = [
  "set -ex && bun run build:shared && bun run build:client && test -f packages/client/dist/index.html && bun run build:server && mkdir -p packages/server/public && cp -r packages/client/dist/* packages/server/public/ && test -f packages/server/public/index.html && mkdir -p packages/server/world/assets/manifests && echo 'Build complete - index.html verified'"
]

[start]
cmd = "cd packages/server && ls -la public/ && test -f public/index.html && echo 'index.html exists' && bun dist/index.js"

[variables]
# Skip asset download in CI - assets are served from CDN
CI = "true"
SKIP_ASSETS = "true"
NODE_ENV = "production"
