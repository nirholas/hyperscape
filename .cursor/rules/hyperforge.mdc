---
description: HyperForge asset generation studio - 3D models, images, audio, content with CDN/Supabase/local storage
alwaysApply: false
---
# HyperForge Asset Generation Studio

HyperForge is the AI-powered asset creation studio for Hyperscape. It generates 3D models, images, audio, and game content that align with the game server's manifest format.

## ğŸ“Œ Core Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        HyperForge Studio                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 3D Gen   â”‚  â”‚ Image    â”‚  â”‚ Audio    â”‚  â”‚ Content Gen      â”‚    â”‚
â”‚  â”‚ (Meshy)  â”‚  â”‚ (OpenAI) â”‚  â”‚ (11Labs) â”‚  â”‚ (GPT-4/Claude)   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â”‚             â”‚             â”‚                  â”‚              â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                              â†“                                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚  Storage Service    â”‚                          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“                     â†“                     â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ CDN       â”‚        â”‚ Supabase  â”‚         â”‚ Local FS  â”‚
   â”‚ (Docker)  â”‚        â”‚ (6 buckets)â”‚        â”‚ (Fallback)â”‚
   â”‚ assets/   â”‚        â”‚           â”‚         â”‚           â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Game Server        â”‚
                    â”‚  (Manifest JSONs)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Package Location

```
packages/hyperforge/
â”œâ”€â”€ lib/                      # Core libraries (Next.js API)
â”‚   â”œâ”€â”€ ai/                   # AI gateway, prompts
â”‚   â”œâ”€â”€ cdn/                  # CDN loader, types
â”‚   â”œâ”€â”€ db/                   # Drizzle DB
â”‚   â””â”€â”€ meshy/                # Meshy 3D generation
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                  # Next.js App Router
â”‚   â”‚   â””â”€â”€ api/              # API routes
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ ai/               # Concept art, sprites
â”‚   â”‚   â”œâ”€â”€ audio/            # ElevenLabs service
â”‚   â”‚   â”œâ”€â”€ generation/       # Content generation
â”‚   â”‚   â”œâ”€â”€ manifest/         # Manifest export
â”‚   â”‚   â””â”€â”€ storage/          # Supabase/local storage
â”‚   â”œâ”€â”€ services/             # Processing services
â”‚   â””â”€â”€ types/                # TypeScript types
â””â”€â”€ public/prompts/           # JSON prompt presets
```

## ğŸ“¦ Storage Architecture

### Priority Order (Serving & Saving)

1. **CDN (Docker)** - Source of truth for production game assets
2. **Supabase Buckets** - AI-generated assets (6 buckets)
3. **Local Filesystem** - Development fallback

### CDN (Docker + assets repo)

The game server serves assets from the `assets/` repo via Docker CDN:

```bash
NEXT_PUBLIC_CDN_URL=http://localhost:8080  # Development
```

**Manifest locations** (development reads from filesystem):
```
packages/server/world/assets/manifests/
â”œâ”€â”€ items.json       # Weapons, armor, tools, resources
â”œâ”€â”€ npcs.json        # Mobs, bosses, quest NPCs
â”œâ”€â”€ resources.json   # Trees, rocks, fishing spots
â”œâ”€â”€ music.json       # Zone themes, combat music
â””â”€â”€ biomes.json      # World zones
```

### Supabase Buckets (6 total)

| Bucket | Purpose | Folder Structure |
|--------|---------|------------------|
| `image-generation` | AI images | `/reference-images/`, `/concept-art/`, `/sprites/`, `/textures/` |
| `audio-generations` | Voice, SFX, Music | `/generated/` |
| `content-generations` | JSON content | `/generated/`, `/game/quests/`, `/game/npcs/`, `/game/dialogues/`, `/game/items/`, `/game/areas/` |
| `meshy-models` | GLB from Meshy | `/{assetId}/model.glb`, `/{assetId}/preview.glb` |
| `vrm-conversion` | VRM models | `/{assetId}/model.vrm` |
| `concept-art-pipeline` | Metadata, thumbnails | `/forge/models/{assetId}/` |

### Local Fallback

```bash
HYPERFORGE_ASSETS_DIR=./assets  # Default: ./assets
```

## ğŸ® Generation Types

### 1. 3D Models (Meshy API)

**See detailed docs**: `.cursor/rules/meshy.mdc`

| Pipeline | API | Description |
|----------|-----|-------------|
| Text-to-3D | v2 | Two-stage: preview â†’ refine |
| Image-to-3D | v1 | Single stage from image |
| Retexture | v1 | New textures on existing model |
| Rigging | v1 | Add skeleton + animations |

**Quality presets**:
```typescript
const qualityOptions = {
  preview: { targetPolycount: 10000, textureResolution: 1024, aiModel: "meshy-4" },
  medium:  { targetPolycount: 30000, textureResolution: 2048, aiModel: "latest" },
  high:    { targetPolycount: 50000, textureResolution: 4096, aiModel: "latest" },
};
```

### 2. Images (OpenAI)

| Type | Service | Output |
|------|---------|--------|
| Concept Art | `concept-art-service.ts` | Texture references for Meshy |
| Sprites | `sprite-service.ts` | Sprite sheets |
| Textures | `openai-service.ts` | Material textures |

### 3. Audio (ElevenLabs)

**See detailed docs**: `.cursor/rules/elevenlabs.mdc`

| Type | Use Case |
|------|----------|
| Voice TTS | NPC dialogue, narration |
| Sound Effects | Combat, items, environment, UI |
| Music | Zone themes, combat, menus |

### 4. Content (GPT-4 / Claude)

| Type | Output Format |
|------|---------------|
| Quest definitions | JSON matching quest schema |
| NPC data | JSON matching NPCManifest |
| Dialogue trees | JSON with nodes + choices |
| Item definitions | JSON matching ItemManifest |
| Area/zone data | JSON with spawn info |

## ğŸ“‹ Manifest Alignment

Generated assets MUST match the game server's manifest schemas.

### Item Manifest Schema

```typescript
interface ItemManifest {
  id: string;                    // Unique ID: "sword_bronze"
  name: string;                  // Display name: "Bronze Sword"
  type: string;                  // "weapon" | "armor" | "tool" | "resource"
  description?: string;
  examine?: string;
  
  // Model paths (asset:// protocol)
  modelPath?: string;            // "asset://models/sword-bronze/sword-bronze.glb"
  equippedModelPath?: string;    // For equipped visuals
  iconPath?: string;
  thumbnailPath?: string;
  
  // Properties
  value?: number;
  weight?: number;
  rarity?: "common" | "uncommon" | "rare" | "epic" | "legendary";
  stackable?: boolean;
  tradeable?: boolean;
  
  // Equipment
  equipSlot?: "weapon" | "shield" | "head" | "body" | "legs" | "hands" | "feet";
  weaponType?: "SWORD" | "AXE" | "MACE" | "DAGGER" | "SPEAR" | "BOW" | "STAFF";
  attackType?: "MELEE" | "RANGED" | "MAGIC";
  
  // Combat bonuses
  bonuses?: { attack?: number; strength?: number; defense?: number; };
  
  // Requirements
  requirements?: { level?: number; skills?: Record<string, number>; };
}
```

### NPC Manifest Schema

```typescript
interface NPCManifest {
  id: string;                    // "goblin_warrior"
  name: string;                  // "Goblin Warrior"
  description?: string;
  category: "mob" | "boss" | "neutral" | "quest";
  faction?: string;
  
  // Stats
  stats?: {
    level?: number;
    health?: number;
    attack?: number;
    strength?: number;
    defense?: number;
  };
  
  // Combat
  combat?: {
    attackable?: boolean;
    aggressive?: boolean;
    aggroRange?: number;
    attackSpeedTicks?: number;
    respawnTicks?: number;
  };
  
  // Appearance (nested OR flattened)
  appearance?: {
    modelPath?: string;
    iconPath?: string;
    scale?: number;
  };
  modelPath?: string;            // Flattened alternative
  
  // Spawning
  spawnBiomes?: string[];
}
```

### Resource Manifest Schema

```typescript
interface ResourceManifest {
  id: string;                    // "oak_tree"
  name: string;                  // "Oak Tree"
  type: string;                  // "tree" | "rock" | "fishing_spot"
  
  modelPath: string | null;
  depletedModelPath?: string;
  scale?: number;
  
  // Harvesting
  harvestSkill?: string;         // "woodcutting"
  toolRequired?: string | null;  // "axe"
  levelRequired?: number;
  
  // Timing
  baseCycleTicks?: number;
  depleteChance?: number;
  respawnTicks?: number;
  
  // Yield
  harvestYield?: Array<{
    itemId: string;
    quantity: number;
    chance: number;
    xpAmount?: number;
  }>;
}
```

## ğŸ”— Asset Path Protocol

Generated assets use the `asset://` protocol for manifest paths:

```typescript
// Format asset path for manifest
function formatAssetPath(localPath: string, assetId: string): string {
  if (localPath.startsWith("asset://")) return localPath;
  const filename = localPath.split("/").pop() || `${assetId}.glb`;
  return `asset://models/${assetId}/${filename}`;
}

// Examples:
// asset://models/sword-bronze/sword-bronze.glb
// asset://models/sword/variants/bronze/model.glb
```

## ğŸš€ Generation Pipeline

### Full 3D Asset Pipeline

```typescript
import { generate3DModel } from "@/lib/generation/generation-service";

const result = await generate3DModel({
  prompt: "Medieval bronze sword with ornate hilt",
  pipeline: "text-to-3d",
  quality: "medium",
  category: "weapon",
  useGPT4Enhancement: true,      // Enhance prompt with GPT-4
  generateConceptArt: true,      // Generate texture reference
  convertToVRM: false,           // For characters/NPCs
  enableHandRigging: false,      // For characters with hands
  metadata: {
    id: "sword_bronze",
    name: "Bronze Sword",
    type: "weapon",
    weaponType: "SWORD",
    rarity: "common",
  },
}, onProgress);

// Result includes:
// - modelUrl: Meshy CDN URL
// - localModelUrl: /api/assets/{id}/model.glb
// - thumbnailUrl, vrmUrl, etc.
```

### Stages

1. **Prompt Enhancement** - GPT-4 improves the prompt
2. **Concept Art** - Generate texture reference image
3. **Text-to-3D Preview** - Untextured mesh
4. **Text-to-3D Refine** - Add textures
5. **Meshy Auto-Rigging** - (optional) Add skeleton
6. **Skeleton Merge** - Merge skeleton into textured model
7. **Hand Rigging** - (optional) Add finger bones
8. **VRM Conversion** - (optional) Convert to VRM 1.0
9. **Save Assets** - To Supabase/local

## ğŸ“¡ API Routes

### 3D Generation

```http
POST /api/generate
POST /api/meshy/status?taskId={id}
POST /api/vrm/convert
POST /api/hand-rigging/simple
```

### Images

```http
POST /api/images/concept-art
POST /api/images/sprites
POST /api/upload/image
```

### Audio

```http
POST /api/audio/voice/generate
POST /api/audio/sfx/generate
POST /api/audio/music/generate
GET  /api/audio/voices
```

### Content

```http
POST /api/content/dialogue
POST /api/content/generate
```

### Manifest

```http
GET  /api/manifest/items
GET  /api/manifest/npcs
POST /api/export/manifest
```

## ğŸ—ƒï¸ Database Schema (Drizzle)

```typescript
// lib/db/schema.ts
export const assets = sqliteTable("assets", {
  id: text("id").primaryKey(),
  name: text("name").notNull(),
  type: text("type").notNull(),
  category: text("category").notNull(),
  status: text("status").default("draft"),
  modelUrl: text("model_url"),
  thumbnailUrl: text("thumbnail_url"),
  metadata: text("metadata"),  // JSON string
  createdAt: integer("created_at").default(Date.now()),
  updatedAt: integer("updated_at"),
});
```

## ğŸ¯ Asset Categories

```typescript
type AssetCategory =
  | "weapon"      // Swords, axes, bows, staves
  | "prop"        // Barrels, crates, furniture
  | "building"    // Houses, shops, structures
  | "npc"         // Mobs, bosses, quest NPCs
  | "character"   // Player avatars, VRM
  | "resource"    // Trees, rocks, fishing spots
  | "environment" // Terrain, foliage
  | "tool"        // Axes, pickaxes, fishing rods
  | "armor"       // Helmets, bodies, legs
  | "item"        // Generic items
  | "currency"    // Coins, tokens
  | "avatar"      // VRM avatars
  | "emote"       // Animation clips
  | "audio"       // Sound effects
  | "music"       // Music tracks
  | "biome";      // World zones
```

## âš™ï¸ Environment Variables

```bash
# CDN
NEXT_PUBLIC_CDN_URL=http://localhost:8080

# Supabase Storage
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SECRET_KEY=sb_secret_xxx

# AI Services
MESHY_API_KEY=xxx
ELEVENLABS_API_KEY=xxx
OPENAI_API_KEY=xxx

# Local Storage (fallback)
HYPERFORGE_ASSETS_DIR=./assets
```

## ğŸ“– Related Documentation

| File | Description |
|------|-------------|
| `.cursor/rules/meshy.mdc` | Meshy 3D generation API |
| `.cursor/rules/elevenlabs.mdc` | ElevenLabs audio API |
| `.cursor/rules/models.mdc` | AI model references |
| `packages/hyperforge/README.md` | Package documentation |

## âš ï¸ Key Rules

1. **Manifest Alignment** - All generated assets must match manifest schemas
2. **Storage Priority** - CDN â†’ Supabase â†’ Local (for both serving and saving)
3. **Asset Protocol** - Use `asset://` paths in manifests
4. **VRM for Characters** - Convert NPCs/characters to VRM for Hyperscape
5. **Polycount Budgets** - Follow Three.js web MMO guidelines
6. **Type Safety** - Match types from `packages/shared/src/types/`

